// SPDX-License-Identifier: GPL-2.0+
/*
 *  T20 LG Star SPL stage configuration
 *
 *  (C) Copyright 2010-2013
 *  NVIDIA Corporation <www.nvidia.com>
 *
 *  (C) Copyright 2023
 *  Svyatoslav Ryhel <clamor95@gmail.com>
 */

#include <asm/arch-tegra/tegra.h>
#include <asm/arch-tegra/tegra_i2c.h>
#include <linux/delay.h>

#define MAX8907_I2C_ADDR		(0x3c << 1)

#define MAX8907_REG_SYSENSEL		0x00
#define MAX8907_REG_SDCTL1		0x04
#define MAX8907_REG_SDV1		0x06
#define MAX8907_REG_SDCTL2		0x07
#define MAX8907_REG_SDV2		0x09
#define MAX8907_REG_SDCTL3		0x0A
#define MAX8907_REG_SDV3		0x0C
#define MAX8907_REG_RESET		0x0F
#define MAX8907_REG_LDOCTL1		0x18
#define MAX8907_REG_LDO1VOUT		0x1A
#define MAX8907_REG_LDOCTL2		0x1C
#define MAX8907_REG_LDO2VOUT		0x1E
#define MAX8907_REG_LDOCTL4		0x24
#define MAX8907_REG_LDO4VOUT		0x26
#define MAX8907_REG_SEQ2		0x65
#define MAX8907_REG_II2RR		0x8F

#define MAX8907_REG_SDCTL1_DATA		(0x0100 | MAX8907_REG_SDCTL1)
#define MAX8907_REG_SDV1_DATA		(0x1d00 | MAX8907_REG_SDV1)
#define MAX8907_REG_SDCTL2_DATA		(0x0100 | MAX8907_REG_SDCTL2)
#define MAX8907_REG_SDV2_DATA		(0x2d00 | MAX8907_REG_SDV2)
#define MAX8907_REG_SDCTL3_DATA		(0x0100 | MAX8907_REG_SDCTL3)
#define MAX8907_REG_SDV3_DATA		(0x1500 | MAX8907_REG_SDV3)
#define MAX8907_REG_LDOCTL1_DATA	(0x0100 | MAX8907_REG_LDOCTL1)
#define MAX8907_REG_LDO1VOUT_DATA	(0x3300 | MAX8907_REG_LDO1VOUT)
#define MAX8907_REG_LDOCTL2_DATA	(0x0100 | MAX8907_REG_LDOCTL2)
#define MAX8907_REG_LDO2VOUT_DATA	(0x1200 | MAX8907_REG_LDO2VOUT)
#define MAX8907_REG_LDOCTL4_DATA	(0x0100 | MAX8907_REG_LDOCTL4)
#define MAX8907_REG_LDO4VOUT_DATA	(0x3300 | MAX8907_REG_LDO4VOUT)

#define MAX8907_REG_SYSENSEL_DATA	0x80
#define MAX8907_REG_RESET_DATA		0x80

#define MAX8907_WORKAROUND_SEQ2		0x12

#define MAX8952_I2C_ADDR		(0x60 << 1)
#define MAX8952_MODE1			0x01
#define MAX8952_MODE1_DATA		(0x1800 | MAX8952_MODE1)

void pmic_enable_cpu_vdd(void)
{
	u16 data = 0;

	/* Setup SYSENSEL register */
	data = tegra_i2c_ll_read(MAX8907_I2C_ADDR, MAX8907_REG_SYSENSEL);
	data |= MAX8907_REG_SYSENSEL_DATA;
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, (data << 8) | MAX8907_REG_SYSENSEL);

	/* Setup RESET register */
	data = tegra_i2c_ll_read(MAX8907_I2C_ADDR, MAX8907_REG_RESET);
	data |= MAX8907_REG_RESET_DATA;
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, (data << 8) | MAX8907_REG_RESET);

	/* Workaround for SEQ2 */
	data = tegra_i2c_ll_read(MAX8907_I2C_ADDR, MAX8907_REG_SEQ2);
	if (data == MAX8907_WORKAROUND_SEQ2) {
		tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SEQ2);
	}

	/* Set V2 VDD_CORE to 1.200V. */
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SDV2_DATA);
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SDCTL2_DATA);
	udelay(1000);

	/* Set LDO2 AVDD_PLLxx to 1.100V. */
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_LDO2VOUT_DATA);
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_LDOCTL2_DATA);
	udelay(1000);

	/* Set V3 VDDIO_SYS to 1.800V. */
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SDV3_DATA);
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SDCTL3_DATA);
	udelay(1000);

	/* Set V1 VCC_IO to 1.200V. */
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SDV1_DATA);
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_SDCTL1_DATA);
	udelay(1000);

	/* Set LDO1 VDDIO_RX_DDR to 3.300V. */
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_LDO1VOUT_DATA);
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_LDOCTL1_DATA);
	udelay(1000);

	/* Set LDO4 AVDD_USB to 3.300V. */
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_LDO4VOUT_DATA);
	tegra_i2c_ll_write(MAX8907_I2C_ADDR, MAX8907_REG_LDOCTL4_DATA);
	udelay(1000);

	/* Bring up VDD_CPU to 1.01V. */
	tegra_i2c_ll_write(MAX8952_I2C_ADDR, MAX8952_MODE1_DATA);
	udelay(10 * 1000);
}
